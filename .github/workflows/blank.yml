name: Build QEMU

on:
  workflow_dispatch:          # 手动触发
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04    # 24.04 自带较新工具链
    strategy:
      matrix:
        arch: [x86_64, aarch64, riscv64, armv7l]
    steps:
      - name: Checkout QEMU
        uses: actions/checkout@v4
        with:
          repository: qemu/qemu
          ref: v8.2.2        # 想追新就改成 master 或 v9.0.0

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential ninja-build meson python3-venv \
            libglib2.0-dev libpixman-1-dev libseccomp-dev \
            libvirglrenderer-dev libepoxy-dev libgtk-3-dev libsdl2-dev \
            libspice-server-dev libusb-1.0-0-dev libusbredirparser-dev \
            libbz2-dev liblzo2-dev libzstd-dev libcurl4-gnutls-dev \
            libgnutls28-dev libfdt-dev libncursesw5-dev pkg-config

      - name: Configure
        run: |
          ./configure --target-list=${{ matrix.arch }}-softmmu \
                      --enable-virglrenderer --enable-opengl \
                      --enable-gtk --enable-sdl --enable-kvm \
                      --enable-vhost-net --enable-libusb \
                      --enable-usb-redir --enable-spice \
                      --enable-seccomp --enable-fdt \
                      --enable-lzo --enable-bzip2 \
                      --enable-tools --enable-vnc \
                      --enable-gnutls --enable-curl \
                      --prefix=$PWD/install

      - name: Compile
        run: |
          make -j$(nproc)
          make install

      - name: Tarball
        run: |
          cd install
          tar -czf ../qemu-${{ matrix.arch }}-linux-gnu.tar.gz *

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v8.2.2-${{ matrix.arch }}
          files: qemu-${{ matrix.arch }}-linux-gnu.tar.gz
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

